From 74438a11577d7ee8b8383629720195804a21c096 Mon Sep 17 00:00:00 2001
From: Trask Stalnaker <trask.stalnaker@gmail.com>
Date: Wed, 28 Jun 2017 18:35:56 -0700
Subject: [PATCH] Add RxJava plugin

---
 agent-parent/distribution/pom.xml                  | 170 +++++++++++++++++++++
 agent/plugins/rxjava-plugin/pom.xml                |  75 +++++++++
 .../glowroot/agent/plugin/rxjava/RxJavaAspect.java |  20 +++
 .../main/resources/META-INF/glowroot.plugin.json   |   7 +
 .../org/glowroot/agent/plugin/rxjava/RxJavaIT.java |  79 ++++++++++
 .../src/test/resources/glowroot.logback-test.xml   |  12 ++
 .../src/test/resources/logback-test.xml            |  12 ++
 pom.xml                                            |   1 +
 8 files changed, 376 insertions(+)
 create mode 100644 agent-parent/distribution/pom.xml
 create mode 100644 agent/plugins/rxjava-plugin/pom.xml
 create mode 100644 agent/plugins/rxjava-plugin/src/main/java/org/glowroot/agent/plugin/rxjava/RxJavaAspect.java
 create mode 100644 agent/plugins/rxjava-plugin/src/main/resources/META-INF/glowroot.plugin.json
 create mode 100644 agent/plugins/rxjava-plugin/src/test/java/org/glowroot/agent/plugin/rxjava/RxJavaIT.java
 create mode 100644 agent/plugins/rxjava-plugin/src/test/resources/glowroot.logback-test.xml
 create mode 100644 agent/plugins/rxjava-plugin/src/test/resources/logback-test.xml

diff --git a/agent-parent/distribution/pom.xml b/agent-parent/distribution/pom.xml
new file mode 100644
index 000000000..8888112c9
--- /dev/null
+++ b/agent-parent/distribution/pom.xml
@@ -0,0 +1,170 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+
+  <parent>
+    <groupId>org.glowroot</groupId>
+    <artifactId>glowroot-parent</artifactId>
+    <version>0.9-SNAPSHOT</version>
+    <relativePath>../..</relativePath>
+  </parent>
+
+  <artifactId>glowroot-agent-distribution</artifactId>
+  <packaging>pom</packaging>
+
+  <name>Glowroot Agent Distribution</name>
+  <description>Glowroot Agent Distribution</description>
+
+  <dependencies>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-cassandra-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-executor-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-grails-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-hibernate-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-http-client-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jaxrs-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jdbc-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jedis-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jms-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jsf-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-jsp-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-logger-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-quartz-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-rxjava-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-servlet-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-spring-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-struts-plugin</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+  </dependencies>
+
+  <build>
+    <finalName>glowroot-${project.version}</finalName>
+    <plugins>
+      <plugin>
+        <groupId>org.glowroot</groupId>
+        <artifactId>glowroot-agent-dist-maven-plugin</artifactId>
+        <version>${project.version}</version>
+        <executions>
+          <execution>
+            <goals>
+              <goal>generate</goal>
+            </goals>
+          </execution>
+        </executions>
+      </plugin>
+      <plugin>
+        <artifactId>maven-assembly-plugin</artifactId>
+        <executions>
+          <execution>
+            <id>dist0</id>
+            <configuration>
+              <descriptors>
+                <descriptor>dist0.xml</descriptor>
+              </descriptors>
+              <archive>
+                <manifestEntries>
+                  <Implementation-Title>${project.name}</Implementation-Title>
+                  <Implementation-Version>${project.version}</Implementation-Version>
+                  <Build-Commit>${glowroot.build.commit}</Build-Commit>
+                  <Build-Time>${maven.build.timestamp}</Build-Time>
+                  <Main-Class>org.glowroot.agent.Viewer</Main-Class>
+                  <Premain-Class>org.glowroot.agent.AgentPremain</Premain-Class>
+                  <Can-Redefine-Classes>true</Can-Redefine-Classes>
+                  <Can-Retransform-Classes>true</Can-Retransform-Classes>
+                </manifestEntries>
+              </archive>
+            </configuration>
+            <phase>package</phase>
+            <goals>
+              <goal>single</goal>
+            </goals>
+          </execution>
+          <execution>
+            <id>dist</id>
+            <configuration>
+              <descriptors>
+                <descriptor>dist.xml</descriptor>
+              </descriptors>
+            </configuration>
+            <phase>package</phase>
+            <goals>
+              <goal>single</goal>
+            </goals>
+          </execution>
+        </executions>
+      </plugin>
+    </plugins>
+  </build>
+</project>
diff --git a/agent/plugins/rxjava-plugin/pom.xml b/agent/plugins/rxjava-plugin/pom.xml
new file mode 100644
index 000000000..c69eebd1a
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/pom.xml
@@ -0,0 +1,75 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+
+  <parent>
+    <groupId>org.glowroot</groupId>
+    <artifactId>glowroot-parent</artifactId>
+    <version>0.9.20-SNAPSHOT</version>
+    <relativePath>../../..</relativePath>
+  </parent>
+
+  <artifactId>glowroot-agent-rxjava-plugin</artifactId>
+
+  <name>Glowroot Agent RxJava Plugin</name>
+  <description>Glowroot Agent RxJava Plugin</description>
+
+  <properties>
+    <!-- instrumented libraries -->
+    <rxjava.version>1.3.0</rxjava.version>
+  </properties>
+
+  <dependencies>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-plugin-api</artifactId>
+      <version>${project.version}</version>
+      <scope>provided</scope>
+    </dependency>
+    <dependency>
+      <groupId>com.google.code.findbugs</groupId>
+      <artifactId>jsr305</artifactId>
+      <!-- don't need this dependency at runtime since only annotations -->
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>junit</groupId>
+      <artifactId>junit</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.assertj</groupId>
+      <artifactId>assertj-core</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.glowroot</groupId>
+      <artifactId>glowroot-agent-it-harness</artifactId>
+      <version>${project.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>io.reactivex</groupId>
+      <artifactId>rxjava</artifactId>
+      <version>${rxjava.version}</version>
+      <scope>test</scope>
+    </dependency>
+  </dependencies>
+
+  <build>
+    <plugins>
+      <plugin>
+        <artifactId>maven-failsafe-plugin</artifactId>
+        <executions>
+          <execution>
+            <goals>
+              <goal>integration-test</goal>
+              <goal>verify</goal>
+            </goals>
+          </execution>
+        </executions>
+      </plugin>
+    </plugins>
+  </build>
+</project>
diff --git a/agent/plugins/rxjava-plugin/src/main/java/org/glowroot/agent/plugin/rxjava/RxJavaAspect.java b/agent/plugins/rxjava-plugin/src/main/java/org/glowroot/agent/plugin/rxjava/RxJavaAspect.java
new file mode 100644
index 000000000..beb63fb9e
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/src/main/java/org/glowroot/agent/plugin/rxjava/RxJavaAspect.java
@@ -0,0 +1,20 @@
+/*
+ * Copyright 2017 the original author or authors.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.glowroot.agent.plugin.rxjava;
+
+public class RxJavaAspect {
+
+}
diff --git a/agent/plugins/rxjava-plugin/src/main/resources/META-INF/glowroot.plugin.json b/agent/plugins/rxjava-plugin/src/main/resources/META-INF/glowroot.plugin.json
new file mode 100644
index 000000000..3e2f5c61e
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/src/main/resources/META-INF/glowroot.plugin.json
@@ -0,0 +1,7 @@
+{
+  "name": "RxJava Plugin",
+  "id": "rxjava",
+  "aspects": [
+    "org.glowroot.agent.plugin.rxjava.RxJavaAspect"
+  ]
+}
diff --git a/agent/plugins/rxjava-plugin/src/test/java/org/glowroot/agent/plugin/rxjava/RxJavaIT.java b/agent/plugins/rxjava-plugin/src/test/java/org/glowroot/agent/plugin/rxjava/RxJavaIT.java
new file mode 100644
index 000000000..629f6cff4
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/src/test/java/org/glowroot/agent/plugin/rxjava/RxJavaIT.java
@@ -0,0 +1,79 @@
+/*
+ * Copyright 2017 the original author or authors.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.glowroot.agent.plugin.rxjava;
+
+import org.junit.After;
+import org.junit.AfterClass;
+import org.junit.BeforeClass;
+import org.junit.Test;
+
+import org.glowroot.agent.it.harness.AppUnderTest;
+import org.glowroot.agent.it.harness.Container;
+import org.glowroot.agent.it.harness.Containers;
+import org.glowroot.agent.it.harness.TransactionMarker;
+import org.glowroot.wire.api.model.TraceOuterClass.Trace;
+
+public class RxJavaIT {
+
+    private static Container container;
+
+    @BeforeClass
+    public static void setUp() throws Exception {
+        container = Containers.create();
+    }
+
+    @AfterClass
+    public static void tearDown() throws Exception {
+        container.close();
+    }
+
+    @After
+    public void afterEachTest() throws Exception {
+        container.checkAndReset();
+    }
+
+    @Test
+    public void shouldCapture() throws Exception {
+        // given
+        // when
+        Trace trace = container.execute(DoSomeReactiveWork.class);
+        // then
+    }
+
+    public static class DoSomeReactiveWork implements AppUnderTest, TransactionMarker {
+
+        @Override
+        public void executeApp() throws Exception {
+            transactionMarker();
+        }
+
+        @Override
+        public void transactionMarker() throws Exception {
+
+        }
+    }
+
+    private static class CreateTraceEntry implements TransactionMarker {
+
+        @Override
+        public void transactionMarker() {
+            try {
+                Thread.sleep(100);
+            } catch (InterruptedException e) {
+            }
+        }
+    }
+}
diff --git a/agent/plugins/rxjava-plugin/src/test/resources/glowroot.logback-test.xml b/agent/plugins/rxjava-plugin/src/test/resources/glowroot.logback-test.xml
new file mode 100644
index 000000000..eb45fd1c8
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/src/test/resources/glowroot.logback-test.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE configuration>
+<configuration>
+  <appender name="CONSOLE" class="org.glowroot.agent.shaded.qos.logback.core.ConsoleAppender">
+    <encoder>
+      <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %logger{36} - %msg%n</pattern>
+    </encoder>
+  </appender>
+  <root level="warn">
+    <appender-ref ref="CONSOLE" />
+  </root>
+</configuration>
diff --git a/agent/plugins/rxjava-plugin/src/test/resources/logback-test.xml b/agent/plugins/rxjava-plugin/src/test/resources/logback-test.xml
new file mode 100644
index 000000000..8c9e643ba
--- /dev/null
+++ b/agent/plugins/rxjava-plugin/src/test/resources/logback-test.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE configuration>
+<configuration>
+  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
+    <encoder>
+      <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %logger{36} - %msg%n</pattern>
+    </encoder>
+  </appender>
+  <root level="warn">
+    <appender-ref ref="CONSOLE" />
+  </root>
+</configuration>
diff --git a/pom.xml b/pom.xml
index e6637534a..b98ad292a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -58,6 +58,7 @@
     <module>agent/plugins/play-plugin</module>
     <module>agent/plugins/quartz-plugin</module>
     <module>agent/plugins/redis-plugin</module>
+    <module>agent/plugins/rxjava-plugin</module>
     <module>agent/plugins/servlet-plugin</module>
     <module>agent/plugins/spring-plugin</module>
     <module>agent/plugins/struts-plugin</module>
-- 
2.13.0.windows.1

